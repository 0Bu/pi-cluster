telegraf:
  image:
    tag: "latest"
  service:
    enabled: false
  pdb:
    create: false
  envFromSecret: telegraf-influxdb-token
  env:
    - name: INFLUXDB_URL
      value: "http://influxdb"
  config: # https://github.com/influxdata/telegraf/blob/master/docs/CONFIGURATION.md
    agent:
      interval: "10s"
      round_interval: true
      metric_batch_size: 1000
      metric_buffer_limit: 10000
      collection_jitter: "0s"
      flush_interval: "10s"
      flush_jitter: "0s"
      precision: ""
      debug: false
      quiet: false
      logfile: ""
      hostname: "$HOSTNAME"
      omit_hostname: true
    processors:
      regex:
        fields: 
        - key: "lastcode"
          pattern: "[^\\x20-\\x7E]"
          replacement: ""
          result_key: "lastcode"
    outputs:
      - influxdb_v2:
          urls:
            - "${INFLUXDB_URL}"
          token: "${INFLUXDB_TOKEN}"
          organization: "influxdata"
          bucket: "ems-esp"
          namepass: ["ems-esp"]
      - file:
          files: ["stdout"]
          namepass: ["ems-esp"]
    inputs:
      - mqtt_consumer: # https://emsesp.org
          name_override: "ems-esp"
          servers: ["tcp://mosquitto:1883"]
          topics: 
            - "ems-esp/#"
          data_format: "json"
